name: Update Firestore on JSON changes

on:
  push:
    paths:
      - 'suuji/**/*.md'
    branches:
      - main
  workflow_dispatch:

jobs:
  update-firestore:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
    
    - name: Get changed Markdown files
      id: changed-files
      run: |
        if [ "${{ github.event_name }}" = "push" ]; then
          CHANGED_FILES=$(git diff --name-only ${{ github.event.before }} ${{ github.sha }} | grep '\.md$' | grep '^suuji/')
        else
          CHANGED_FILES=$(find suuji -name "*.md" -type f)
        fi
        
        echo "files=$CHANGED_FILES" >> $GITHUB_OUTPUT
        echo "Changed Markdown files:"
        echo "$CHANGED_FILES"
    
    - name: Process Markdown files and update Firestore
      if: steps.changed-files.outputs.files != ''
      run: |
        echo "${{ steps.changed-files.outputs.files }}" | while read -r file; do
          if [ -n "$file" ] && [ -f "$file" ]; then
            echo "Processing file: $file"
            
            # ãƒ•ã‚¡ã‚¤ãƒ«åã‹ã‚‰KEYã‚’å–å¾—ï¼ˆä¾‹: suuji/0-999/0-99/2.md -> 2ï¼‰
            KEY=$(basename "$file" .md)
            
            # Markdownãƒ•ã‚¡ã‚¤ãƒ«ã‹ã‚‰å†…å®¹ã‚’èª­ã¿å–ã‚Šï¼ˆ# æ¦‚è¦ ã‚‚å«ã‚ã‚‹ï¼‰
            # æ”¹è¡Œã‚’\\nã«å¤‰æ›ã—ã¦Firestoreã§æ­£ã—ãè¡¨ç¤ºã•ã‚Œã‚‹ã‚ˆã†ã«ã™ã‚‹
            DESCRIPTION=$(cat "$file" | sed 's/^[[:space:]]*//;s/[[:space:]]*$//' | sed ':a;N;$!ba;s/\n/\\n/g')
            
            if [ -n "$KEY" ]; then
              echo "ðŸ” Processing key: $KEY"
              echo "ðŸ“„ Description length: ${#DESCRIPTION} characters"
              echo "ðŸ“ Description preview: ${DESCRIPTION:0:100}..."
              
              # jqã‚’ä½¿ã£ã¦é©åˆ‡ã«JSONã‚’æ§‹ç¯‰
              JSON_PAYLOAD=$(jq -n --arg key "$KEY" --arg description "$DESCRIPTION" '{key: ($key | tonumber), description: $description}')
              
              echo "ðŸ“¤ Sending JSON payload to API..."
              echo "ðŸ”— API URL: ${{ secrets.SUUJI_HANDLE_NUMBER_API_URL_DEV }}"
              
              # HandleNumber APIã‚’å‘¼ã³å‡ºã—
              curl -X POST "${{ secrets.SUUJI_HANDLE_NUMBER_API_URL_DEV }}" \
                -H "Content-Type: application/json" \
                -d "$JSON_PAYLOAD" \
                --fail-with-body \
                --silent --show-error
              
              echo "âœ… Successfully processed key: $KEY"
            else
              echo "Warning: No key found in file $file"
            fi
          fi
        done
    
    - name: Summary
      run: |
        echo "## ðŸ“Š Processing Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### ðŸ“ Processed Markdown files:" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "${{ steps.changed-files.outputs.files }}" >> $GITHUB_STEP_SUMMARY
        echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "### âœ… Results" >> $GITHUB_STEP_SUMMARY
        echo "- All Markdown files have been processed successfully" >> $GITHUB_STEP_SUMMARY
        echo "- Firestore has been updated with the latest content" >> $GITHUB_STEP_SUMMARY
        echo "- Newline characters have been properly escaped for Firestore" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "ðŸŽ‰ **Workflow completed successfully!**" >> $GITHUB_STEP_SUMMARY
